service: HackatonBackend

plugins:
  - serverless-prune-plugin
  - serverless-offline

custom:
  prune:
    automatic: true
    number: 2
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
  bucketName: hackatonbackend-documents-v23-${self:provider.stage}

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    WORKERS_TABLE: ${self:service}-workers-${self:provider.stage}
    SIGNATURE_REQUESTS_TABLE: ${self:service}-signature-requests-${self:provider.stage}
    SIGNATURES_TABLE: ${self:service}-signatures-${self:provider.stage}
    USERS_TABLE: ${self:service}-users-${self:provider.stage}
    SESSIONS_TABLE: ${self:service}-sessions-${self:provider.stage}
    SURVEYS_TABLE: ${self:service}-surveys-${self:provider.stage}
    SES_SENDER_EMAIL: 'benjasncz@gmail.com'
    INCIDENTS_TABLE: ${self:service}-incidents-${self:provider.stage}
    INCIDENT_EVIDENCE_BUCKET: hackatonbackend-incident-evidence-${self:provider.stage}-${aws:accountId}
    INCIDENT_NOTIFICATION_TOPIC: ${self:service}-incident-notifications-${self:provider.stage}
    DOCUMENTS_BUCKET: ${self:custom.bucketName}
    INBOX_TABLE: ${self:service}-inbox-${self:provider.stage}
    IS_OFFLINE: ${env:IS_OFFLINE, 'false'}
  httpApi:
    cors:
      allowedOrigins:
        - '*'
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt WorkersTable.Arn
            - !GetAtt SignatureRequestsTable.Arn
            - !GetAtt SignaturesTable.Arn
            - !Sub ${SignaturesTable.Arn}/index/*
            - !GetAtt UsersTable.Arn
            - !GetAtt SessionsTable.Arn
            - !GetAtt SurveysTable.Arn
            - !GetAtt IncidentsTable.Arn
            - !GetAtt InboxTable.Arn
            - !Sub ${InboxTable.Arn}/index/*
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - !Sub '${IncidentEvidenceBucket.Arn}/*'
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - !Sub 'arn:aws:s3:::${self:custom.bucketName}/*'
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref IncidentNotificationTopic
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource:
            - "arn:aws:bedrock:*::foundation-model/anthropic.*"
            - "arn:aws:bedrock:*::foundation-model/amazon.*"

package:
  individually: false
  excludeDevDependencies: true
  patterns:
    - '!node_modules/.prisma/**'
    - '!node_modules/@prisma/**'
    - '!node_modules/.bin/**'
    - '!tests/**'
    - '!**/__tests__/**'

functions:
  # Auth (Autenticaci√≥n)
  authLogin:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: POST

  authChangePassword:
    handler: handlers/auth.changePassword
    events:
      - httpApi:
          path: /auth/change-password
          method: POST

  authLogout:
    handler: handlers/auth.logout
    events:
      - httpApi:
          path: /auth/logout
          method: POST

  authMe:
    handler: handlers/auth.me
    events:
      - httpApi:
          path: /auth/me
          method: GET

  authValidateToken:
    handler: handlers/auth.validateToken
    events:
      - httpApi:
          path: /auth/validate-token
          method: POST

  # Users (Usuarios)
  usersModule:
    handler: handlers/users-module/users.handler.usersHandler
    events:
      - httpApi:
          path: /users
          method: any
      - httpApi:
          path: /users/{proxy+}
          method: any

  # Workers (Trabajadores/Enrolamiento)
  createWorker:
    handler: handlers/workers.create
    events:
      - httpApi:
          path: /workers
          method: POST

  listWorkers:
    handler: handlers/workers.list
    events:
      - httpApi:
          path: /workers
          method: GET

  getWorker:
    handler: handlers/workers.get
    events:
      - httpApi:
          path: /workers/{id}
          method: GET

  updateWorker:
    handler: handlers/workers.update
    events:
      - httpApi:
          path: /workers/{id}
          method: PUT

  signWorker:
    handler: handlers/workers.sign
    events:
      - httpApi:
          path: /workers/{id}/sign
          method: POST

  getWorkerByRut:
    handler: handlers/workers.getByRut
    events:
      - httpApi:
          path: /workers/rut/{rut}
          method: GET

  setWorkerPin:
    handler: handlers/workers.setPin
    events:
      - httpApi:
          path: /workers/{id}/set-pin
          method: POST

  completeWorkerEnrollment:
    handler: handlers/workers.completeEnrollment
    events:
      - httpApi:
          path: /workers/{id}/complete-enrollment
          method: POST

  # ========================================
  # SIGNATURE REQUESTS (Solicitudes de Firma)
  # ========================================
  createSignatureRequest:
    handler: handlers/signature-requests.create
    events:
      - httpApi:
          path: /signature-requests
          method: POST

  listSignatureRequests:
    handler: handlers/signature-requests.list
    events:
      - httpApi:
          path: /signature-requests
          method: GET

  getSignatureRequest:
    handler: handlers/signature-requests.get
    events:
      - httpApi:
          path: /signature-requests/{id}
          method: GET

  getPendingByWorker:
    handler: handlers/signature-requests.getPendingByWorker
    events:
      - httpApi:
          path: /signature-requests/pending/{workerId}
          method: GET

  getHistoryByWorker:
    handler: handlers/signature-requests.getHistoryByWorker
    events:
      - httpApi:
          path: /signature-requests/history/{workerId}
          method: GET

  cancelSignatureRequest:
    handler: handlers/signature-requests.cancel
    events:
      - httpApi:
          path: /signature-requests/{id}/cancel
          method: POST

  getSignatureRequestStats:
    handler: handlers/signature-requests.getStats
    events:
      - httpApi:
          path: /signature-requests/stats
          method: GET

  processOfflineBatch:
    handler: handlers/signature-requests.processOfflineBatch
    events:
      - httpApi:
          path: /signature-requests/offline-batch
          method: POST

  # ========================================
  # SIGNATURES (Firmas Digitales)
  # ========================================
  createSignature:
    handler: handlers/signatures-new.create
    events:
      - httpApi:
          path: /signatures
          method: POST

  createEnrollmentSignature:
    handler: handlers/signatures-new.createEnrollment
    events:
      - httpApi:
          path: /signatures/enroll
          method: POST

  getSignature:
    handler: handlers/signatures-new.get
    events:
      - httpApi:
          path: /signatures/{id}
          method: GET

  getSignaturesByWorker:
    handler: handlers/signatures-new.getByWorker
    events:
      - httpApi:
          path: /signatures/worker/{workerId}
          method: GET

  getSignaturesByRequest:
    handler: handlers/signatures-new.getByRequest
    events:
      - httpApi:
          path: /signatures/request/{requestId}
          method: GET

  verifySignatureByToken:
    handler: handlers/signatures-new.verifyByToken
    events:
      - httpApi:
          path: /signatures/verify/{token}
          method: GET

  disputeSignature:
    handler: handlers/signatures-new.dispute
    events:
      - httpApi:
          path: /signatures/{id}/dispute
          method: POST

  resolveSignatureDispute:
    handler: handlers/signatures-new.resolve
    events:
      - httpApi:
          path: /signatures/{id}/resolve
          method: PUT

  listSignatureDisputes:
    handler: handlers/signatures-new.listDisputes
    events:
      - httpApi:
          path: /signatures/disputes
          method: GET

  # ========================================
  # UPLOADS (Subida de archivos a S3)
  # ========================================
  getUploadUrl:
    handler: handlers/uploads.getUploadUrl
    events:
      - httpApi:
          path: /uploads/presigned-url
          method: POST

  getDownloadUrl:
    handler: handlers/uploads.getDownloadUrl
    events:
      - httpApi:
          path: /uploads/download-url
          method: POST

  confirmUpload:
    handler: handlers/uploads.confirmUpload
    events:
      - httpApi:
          path: /uploads/confirm
          method: POST

  deleteUpload:
    handler: handlers/uploads.deleteFile
    events:
      - httpApi:
          path: /uploads/{fileKey}
          method: DELETE

  getBatchDownloadUrls:
    handler: handlers/uploads.getBatchDownloadUrls
    events:
      - httpApi:
          path: /uploads/batch-download-urls
          method: POST

  # AI Assistant (Asistente IA)
  aiChat:
    handler: handlers/ai-assistant.chat
    events:
      - httpApi:
          path: /ai/chat
          method: POST

  aiRiskMatrix:
    handler: handlers/ai-assistant.generateRiskMatrix
    events:
      - httpApi:
          path: /ai/risk-matrix
          method: POST

  aiPreventionPlan:
    handler: handlers/ai-assistant.generatePreventionPlan
    events:
      - httpApi:
          path: /ai/prevention-plan
          method: POST

  aiDailyTalk:
    handler: handlers/ai-assistant.generateDailyTalk
    events:
      - httpApi:
          path: /ai/daily-talk
          method: POST

  aiMIPER:
    handler: handlers/ai-assistant.generateMIPER
    events:
      - httpApi:
          path: /ai/miper
          method: POST

  aiAnalyzeIncident:
    handler: handlers/ai-assistant.analyzeIncident
    events:
      - httpApi:
          path: /ai/analyze-incident
          method: POST

  # Surveys (Encuestas)
  createSurvey:
    handler: handlers/surveys.create
    events:
      - httpApi:
          path: /surveys
          method: POST

  listSurveys:
    handler: handlers/surveys.list
    events:
      - httpApi:
          path: /surveys
          method: GET

  getSurvey:
    handler: handlers/surveys.get
    events:
      - httpApi:
          path: /surveys/{id}
          method: GET

  updateSurveyResponse:
    handler: handlers/surveys.updateResponseStatus
    events:
      - httpApi:
          path: /surveys/{id}/responses/{workerId}
          method: POST

  # Incidents (Incidentes y Accidentes)
  createIncident:
    handler: handlers/incidents.create
    events:
      - httpApi:
          path: /incidents
          method: POST

  listIncidents:
    handler: handlers/incidents.list
    events:
      - httpApi:
          path: /incidents
          method: GET

  getIncident:
    handler: handlers/incidents.get
    events:
      - httpApi:
          path: /incidents/{id}
          method: GET

  updateIncident:
    handler: handlers/incidents.update
    events:
      - httpApi:
          path: /incidents/{id}
          method: PUT

  uploadIncidentEvidence:
    handler: handlers/incidents.uploadEvidence
    events:
      - httpApi:
          path: /incidents/upload-evidence
          method: POST

  getIncidentStats:
    handler: handlers/incidents.getStats
    events:
      - httpApi:
          path: /incidents/stats
          method: GET

  # Nuevos endpoints de incidentes (Fase 4)
  addIncidentInvestigation:
    handler: handlers/incidents.addInvestigation
    events:
      - httpApi:
          path: /incidents/{id}/investigations
          method: POST

  uploadIncidentDocument:
    handler: handlers/incidents.uploadDocument
    events:
      - httpApi:
          path: /incidents/{id}/documents
          method: POST

  getIncidentDocuments:
    handler: handlers/incidents.getDocuments
    events:
      - httpApi:
          path: /incidents/{id}/documents
          method: GET

  getIncidentAnalytics:
    handler: handlers/incidents.getAnalytics
    events:
      - httpApi:
          path: /incidents/analytics
          method: GET

  quickReportIncident:
    handler: handlers/incidents.quickReport
    events:
      - httpApi:
          path: /incidents/quick-report
          method: POST

  # Hello (Test)
  printHello:
    handler: handlers/hola.printHello
    events:
      - httpApi:
          path: /hello
          method: GET

  # Notifications
  sendWelcomeEmail:
    handler: handlers/notifications.sendWelcome
    events:
      - httpApi:
          path: /test-email
          method: POST

  inboxModule:
    handler: handlers/inbox-module/handler.inboxHandler
    events:
      - httpApi:
          path: /inbox
          method: any
      - httpApi:
          path: /inbox/{proxy+}
          method: any

resources:
  Resources:
    # S3 Bucket para documentos
    DocumentsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.bucketName}
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
                - DELETE
              AllowedOrigins:
                - '*'
              MaxAge: 3000

    # Workers Table
    WorkersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.WORKERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: workerId
            AttributeType: S
        KeySchema:
          - AttributeName: workerId
            KeyType: HASH

    # Signature Requests Table
    SignatureRequestsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SIGNATURE_REQUESTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: requestId
            AttributeType: S
        KeySchema:
          - AttributeName: requestId
            KeyType: HASH

    # Signatures Table con GSI para requestId
    SignaturesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SIGNATURES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: signatureId
            AttributeType: S
          - AttributeName: requestId
            AttributeType: S
        KeySchema:
          - AttributeName: signatureId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: requestId-index
            KeySchema:
              - AttributeName: requestId
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    # Users Table
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH

    # Sessions Table
    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SESSIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH

    SurveysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SURVEYS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: surveyId
            AttributeType: S
        KeySchema:
          - AttributeName: surveyId
            KeyType: HASH
    IncidentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.INCIDENTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: incidentId
            AttributeType: S
          - AttributeName: empresaId
            AttributeType: S
          - AttributeName: fecha
            AttributeType: S
        KeySchema:
          - AttributeName: incidentId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: empresaId-fecha-index
            KeySchema:
              - AttributeName: empresaId
                KeyType: HASH
              - AttributeName: fecha
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    IncidentEvidenceBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.INCIDENT_EVIDENCE_BUCKET}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
              MaxAge: 3000

    IncidentNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:provider.environment.INCIDENT_NOTIFICATION_TOPIC}
        DisplayName: Notificaciones de Incidentes y Accidentes

    # Inbox Messages Table
    InboxTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.INBOX_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: recipientId
            AttributeType: S
          - AttributeName: messageId
            AttributeType: S
          - AttributeName: senderId
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: recipientId
            KeyType: HASH
          - AttributeName: messageId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: senderId-createdAt-index
            KeySchema:
              - AttributeName: senderId
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
