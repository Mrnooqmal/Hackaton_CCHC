service: HackatonBackend

plugins:
  - serverless-prune-plugin
  - serverless-offline

custom:
  prune:
    automatic: true
    number: 5
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    WORKERS_TABLE: ${self:service}-workers-${self:provider.stage}
    DOCUMENTS_TABLE: ${self:service}-documents-${self:provider.stage}
    ACTIVITIES_TABLE: ${self:service}-activities-${self:provider.stage}
    SIGNATURES_TABLE: ${self:service}-signatures-${self:provider.stage}
    USERS_TABLE: ${self:service}-users-${self:provider.stage}
    SESSIONS_TABLE: ${self:service}-sessions-${self:provider.stage}
    SURVEYS_TABLE: ${self:service}-surveys-${self:provider.stage}
    SES_SENDER_EMAIL: 'thecodecookers@gmail.com'
    INCIDENTS_TABLE: ${self:service}-incidents-${self:provider.stage}
    INCIDENT_EVIDENCE_BUCKET: hackatonbackend-incident-evidence-${self:provider.stage}-${aws:accountId}
    INCIDENT_NOTIFICATION_TOPIC: ${self:service}-incident-notifications-${self:provider.stage}
    IS_OFFLINE: ${env:IS_OFFLINE, 'false'}
  httpApi:
    cors:
      allowedOrigins:
        - '*'
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - !GetAtt WorkersTable.Arn
            - !GetAtt DocumentsTable.Arn
            - !GetAtt ActivitiesTable.Arn
            - !GetAtt SignaturesTable.Arn
            - !GetAtt UsersTable.Arn
            - !GetAtt SessionsTable.Arn
            - !GetAtt SurveysTable.Arn
            - !GetAtt IncidentsTable.Arn
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - !Sub '${IncidentEvidenceBucket.Arn}/*'
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref IncidentNotificationTopic

package:
  individually: false
  excludeDevDependencies: true
  patterns:
    - '!node_modules/.prisma/**'
    - '!node_modules/@prisma/**'
    - '!node_modules/.bin/**'
    - '!tests/**'
    - '!**/__tests__/**'

functions:
  # Auth (Autenticaci√≥n)
  authLogin:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: POST

  authChangePassword:
    handler: handlers/auth.changePassword
    events:
      - httpApi:
          path: /auth/change-password
          method: POST

  authLogout:
    handler: handlers/auth.logout
    events:
      - httpApi:
          path: /auth/logout
          method: POST

  authMe:
    handler: handlers/auth.me
    events:
      - httpApi:
          path: /auth/me
          method: GET

  authValidateToken:
    handler: handlers/auth.validateToken
    events:
      - httpApi:
          path: /auth/validate-token
          method: POST

  # Users (Usuarios)
  createUser:
    handler: handlers/users.create
    events:
      - httpApi:
          path: /users
          method: POST

  listUsers:
    handler: handlers/users.list
    events:
      - httpApi:
          path: /users
          method: GET

  getUser:
    handler: handlers/users.get
    events:
      - httpApi:
          path: /users/{id}
          method: GET

  getUserByRut:
    handler: handlers/users.getByRut
    events:
      - httpApi:
          path: /users/rut/{rut}
          method: GET

  updateUser:
    handler: handlers/users.update
    events:
      - httpApi:
          path: /users/{id}
          method: PUT

  resetUserPassword:
    handler: handlers/users.resetPassword
    events:
      - httpApi:
          path: /users/{id}/reset-password
          method: POST

  setUserPin:
    handler: handlers/users.setPin
    events:
      - httpApi:
          path: /users/{id}/set-pin
          method: POST

  completeUserEnrollment:
    handler: handlers/users.completeEnrollment
    events:
      - httpApi:
          path: /users/{id}/complete-enrollment
          method: POST

  # Workers (Trabajadores/Enrolamiento)
  createWorker:
    handler: handlers/workers.create
    events:
      - httpApi:
          path: /workers
          method: POST

  listWorkers:
    handler: handlers/workers.list
    events:
      - httpApi:
          path: /workers
          method: GET

  getWorker:
    handler: handlers/workers.get
    events:
      - httpApi:
          path: /workers/{id}
          method: GET

  updateWorker:
    handler: handlers/workers.update
    events:
      - httpApi:
          path: /workers/{id}
          method: PUT

  signWorker:
    handler: handlers/workers.sign
    events:
      - httpApi:
          path: /workers/{id}/sign
          method: POST

  getWorkerByRut:
    handler: handlers/workers.getByRut
    events:
      - httpApi:
          path: /workers/rut/{rut}
          method: GET

  setWorkerPin:
    handler: handlers/workers.setPin
    events:
      - httpApi:
          path: /workers/{id}/set-pin
          method: POST

  completeWorkerEnrollment:
    handler: handlers/workers.completeEnrollment
    events:
      - httpApi:
          path: /workers/{id}/complete-enrollment
          method: POST

  # Signatures (Firmas Digitales)
  createSignature:
    handler: handlers/signatures.create
    events:
      - httpApi:
          path: /signatures
          method: POST

  getSignature:
    handler: handlers/signatures.get
    events:
      - httpApi:
          path: /signatures/{id}
          method: GET

  getSignaturesByWorker:
    handler: handlers/signatures.getByWorker
    events:
      - httpApi:
          path: /signatures/worker/{workerId}
          method: GET

  disputeSignature:
    handler: handlers/signatures.dispute
    events:
      - httpApi:
          path: /signatures/{id}/dispute
          method: POST

  resolveSignatureDispute:
    handler: handlers/signatures.resolve
    events:
      - httpApi:
          path: /signatures/{id}/resolve
          method: PUT

  listSignatureDisputes:
    handler: handlers/signatures.listDisputes
    events:
      - httpApi:
          path: /signatures/disputes
          method: GET

  # Documents (Documentos)
  createDocument:
    handler: handlers/documents.create
    events:
      - httpApi:
          path: /documents
          method: POST

  listDocuments:
    handler: handlers/documents.list
    events:
      - httpApi:
          path: /documents
          method: GET

  getDocument:
    handler: handlers/documents.get
    events:
      - httpApi:
          path: /documents/{id}
          method: GET

  assignDocument:
    handler: handlers/documents.assign
    events:
      - httpApi:
          path: /documents/{id}/assign
          method: POST

  signDocument:
    handler: handlers/documents.sign
    events:
      - httpApi:
          path: /documents/{id}/sign
          method: POST

  signDocumentBulk:
    handler: handlers/documents.signBulk
    events:
      - httpApi:
          path: /documents/{id}/sign-bulk
          method: POST

  # Activities (Actividades)
  createActivity:
    handler: handlers/activities.create
    events:
      - httpApi:
          path: /activities
          method: POST

  listActivities:
    handler: handlers/activities.list
    events:
      - httpApi:
          path: /activities
          method: GET

  getActivity:
    handler: handlers/activities.get
    events:
      - httpApi:
          path: /activities/{id}
          method: GET

  registerAttendance:
    handler: handlers/activities.registerAttendance
    events:
      - httpApi:
          path: /activities/{id}/attendance
          method: POST

  getActivityStats:
    handler: handlers/activities.getStats
    events:
      - httpApi:
          path: /activities/stats
          method: GET

  # AI Assistant (Asistente IA)
  aiChat:
    handler: handlers/ai-assistant.chat
    events:
      - httpApi:
          path: /ai/chat
          method: POST

  aiRiskMatrix:
    handler: handlers/ai-assistant.generateRiskMatrix
    events:
      - httpApi:
          path: /ai/risk-matrix
          method: POST

  aiPreventionPlan:
    handler: handlers/ai-assistant.generatePreventionPlan
    events:
      - httpApi:
          path: /ai/prevention-plan
          method: POST

  aiDailyTalk:
    handler: handlers/ai-assistant.generateDailyTalk
    events:
      - httpApi:
          path: /ai/daily-talk
          method: POST

  # Surveys (Encuestas)
  createSurvey:
    handler: handlers/surveys.create
    events:
      - httpApi:
          path: /surveys
          method: POST

  listSurveys:
    handler: handlers/surveys.list
    events:
      - httpApi:
          path: /surveys
          method: GET

  getSurvey:
    handler: handlers/surveys.get
    events:
      - httpApi:
          path: /surveys/{id}
          method: GET

  updateSurveyResponse:
    handler: handlers/surveys.updateResponseStatus
    events:
      - httpApi:
          path: /surveys/{id}/responses/{workerId}
          method: POST

  # Incidents (Incidentes y Accidentes)
  createIncident:
    handler: handlers/incidents.create
    events:
      - httpApi:
          path: /incidents
          method: POST

  listIncidents:
    handler: handlers/incidents.list
    events:
      - httpApi:
          path: /incidents
          method: GET

  getIncident:
    handler: handlers/incidents.get
    events:
      - httpApi:
          path: /incidents/{id}
          method: GET

  updateIncident:
    handler: handlers/incidents.update
    events:
      - httpApi:
          path: /incidents/{id}
          method: PUT

  uploadIncidentEvidence:
    handler: handlers/incidents.uploadEvidence
    events:
      - httpApi:
          path: /incidents/upload-evidence
          method: POST

  getIncidentStats:
    handler: handlers/incidents.getStats
    events:
      - httpApi:
          path: /incidents/stats
          method: GET

  # Hello (Test)
  printHello:
    handler: handlers/hola.printHello
    events:
      - httpApi:
          path: /hello
          method: GET

  # Notifications
  sendWelcomeEmail:
    handler: handlers/notifications.sendWelcome
    events:
      - httpApi:
          path: /test-email
          method: POST

resources:
  Resources:
    WorkersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.WORKERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: workerId
            AttributeType: S
        KeySchema:
          - AttributeName: workerId
            KeyType: HASH

    DocumentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DOCUMENTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: documentId
            AttributeType: S
        KeySchema:
          - AttributeName: documentId
            KeyType: HASH

    ActivitiesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ACTIVITIES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: activityId
            AttributeType: S
        KeySchema:
          - AttributeName: activityId
            KeyType: HASH

    SignaturesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SIGNATURES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: signatureId
            AttributeType: S
        KeySchema:
          - AttributeName: signatureId
            KeyType: HASH

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SESSIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH

    SurveysTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.SURVEYS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: surveyId
            AttributeType: S
        KeySchema:
          - AttributeName: surveyId
            KeyType: HASH
    IncidentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.INCIDENTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: incidentId
            AttributeType: S
          - AttributeName: empresaId
            AttributeType: S
          - AttributeName: fecha
            AttributeType: S
        KeySchema:
          - AttributeName: incidentId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: empresaId-fecha-index
            KeySchema:
              - AttributeName: empresaId
                KeyType: HASH
              - AttributeName: fecha
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    IncidentEvidenceBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.INCIDENT_EVIDENCE_BUCKET}
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - '*'
              MaxAge: 3000

    IncidentNotificationTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: ${self:provider.environment.INCIDENT_NOTIFICATION_TOPIC}
        DisplayName: Notificaciones de Incidentes y Accidentes
